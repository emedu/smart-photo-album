<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æä¸­ - æ™ºæ…§ç›¸ç°¿ç³»çµ±</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .analysis-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .analysis-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 3rem;
            width: 100%;
            text-align: center;
        }

        .progress-circle {
            width: 200px;
            height: 200px;
            margin: 0 auto 2rem;
            position: relative;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            stroke-dasharray: 565.48;
            stroke-dashoffset: 565.48;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: 700;
        }

        .stage-text {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: var(--radius-sm);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
    </style>
</head>

<body>
    <div class="analysis-container">
        <div class="analysis-card">
            <h1 class="title" style="margin-bottom: 1rem;">AI åˆ†æä¸­</h1>

            <!-- é€²åº¦åœ“ç’° -->
            <div class="progress-circle">
                <svg width="200" height="200" class="progress-ring">
                    <circle class="progress-ring-circle" stroke="url(#gradient)" stroke-width="8" fill="transparent"
                        r="90" cx="100" cy="100" />
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea" />
                            <stop offset="100%" style="stop-color:#764ba2" />
                        </linearGradient>
                    </defs>
                </svg>
                <div class="progress-text" id="progressText">0%</div>
            </div>

            <div class="stage-text" id="stageText">æ­£åœ¨åˆå§‹åŒ–...</div>

            <!-- çµ±è¨ˆè³‡è¨Š -->
            <div class="stats-grid" id="statsGrid" style="display: none;">
                <div class="stat-item">
                    <div class="stat-label">å·²åˆ†æç…§ç‰‡</div>
                    <div class="stat-value" id="photoCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å·²åˆ†æå½±ç‰‡</div>
                    <div class="stat-value" id="videoCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ç¸½é …ç›®æ•¸</div>
                    <div class="stat-value" id="totalCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">é è¨ˆä¿ç•™</div>
                    <div class="stat-value" id="selectedCount">0</div>
                </div>
            </div>

            <p style="margin-top: 2rem; color: var(--text-muted); font-size: 0.875rem;">
                â±ï¸ è™•ç†æ™‚é–“è¦–ç›¸ç°¿å¤§å°è€Œå®š,è«‹è€å¿ƒç­‰å€™
            </p>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script src="/js/analysis.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('jobId');

        if (!jobId) {
            alert('ç¼ºå°‘ä»»å‹™ ID');
            window.location.href = '/dashboard.html';
        }

        // æ›´æ–°é€²åº¦åœ“ç’°
        function updateProgress(percentage) {
            const circle = document.querySelector('.progress-ring-circle');
            const circumference = 2 * Math.PI * 90;
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            document.getElementById('progressText').textContent = Math.round(percentage) + '%';
        }

        // æ›´æ–°éšæ®µæ–‡å­—
        function updateStage(stage) {
            const stageTexts = {
                'fetching': 'ğŸ“¥ æ­£åœ¨å–å¾—ç›¸ç°¿å…§å®¹...',
                'analyzing': 'ğŸ¤– AI åˆ†æä¸­...',
                'analyzing_photos': 'ğŸ“¸ æ­£åœ¨åˆ†æç…§ç‰‡å“è³ª...',
                'analyzing_videos': 'ğŸ¬ æ­£åœ¨åˆ†æå½±ç‰‡å…§å®¹...',
                'creating_albums': 'ğŸ“ æ­£åœ¨å»ºç«‹ç²¾é¸ç›¸ç°¿...',
                'completed': 'âœ… åˆ†æå®Œæˆ!'
            };

            document.getElementById('stageText').textContent = stageTexts[stage] || stage;
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats(data) {
            if (data.totalPhotos || data.totalVideos) {
                document.getElementById('statsGrid').style.display = 'grid';
                document.getElementById('photoCount').textContent = data.currentPhoto || 0;
                document.getElementById('videoCount').textContent = data.currentVideo || 0;
                document.getElementById('totalCount').textContent =
                    (data.totalPhotos || 0) + (data.totalVideos || 0);
            }
        }

        // é–‹å§‹ç›£è½é€²åº¦
        monitorProgress(jobId, (status) => {
            updateProgress(status.progress || 0);
            updateStage(status.stage || 'processing');
            updateStats(status);

            // å¦‚æœå®Œæˆ,è·³è½‰åˆ°çµæœé é¢
            if (status.status === 'completed') {
                setTimeout(() => {
                    window.location.href = `/results.html?jobId=${jobId}`;
                }, 1500);
            }

            // å¦‚æœå¤±æ•—,é¡¯ç¤ºéŒ¯èª¤
            if (status.status === 'failed') {
                alert('åˆ†æå¤±æ•—: ' + (status.error || 'æœªçŸ¥éŒ¯èª¤'));
                window.location.href = '/dashboard.html';
            }
        });
    </script>
</body>

</html>