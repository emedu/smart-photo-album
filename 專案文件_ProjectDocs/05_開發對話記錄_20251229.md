# 開發對話與問題排查記錄 (2025-12-29/30)

本文檔記錄了「智慧相簿自動過濾與管理系統」開發過程中的關鍵對話、決策點以及技術問題排查過程，特別是關於 Google Photos API 整合的詳細診斷。

## 📅 專案啟動與環境設定

### 1. 初始化與 Port 設定
- **目標**: 啟動專案並確保環境變數正確。
- **問題**: 預設 Port 3000 與 OAuth 回調不匹配。
- **解決方案**:
  - 將 Port 全面更改為 **3001**。
  - 更新了 `.env`, `server.js`, `README.md` 及所有相關文件。
  - 確認 OAuth Redirect URI 為 `http://localhost:3001/auth/callback`。

### 2. API 金鑰與 OAuth 設定
- **Google Photos API**:
  - 協助申請 Client ID 和 Secret。
  - 設定 Scope: `photoslibrary.readonly`, `photoslibrary.appendonly`。
- **Gemini API**:
  - 設定 API Key 於環境變數。

---

## 🔧 Google Photos API 整合與除錯紀錄 (重點)

這是本次開發中最耗時也最關鍵的技術排查過程。

### 階段 1: 程式庫問題
- **症狀**: 伺服器報錯 `google.photoslibrary is not a function`。
- **診斷**: `googleapis` Node.js 客戶端庫並未直接包含 Photos Library 的便捷方法。
- **解決**: 
  - 放棄 `googleapis` 的內建方法。
  - 改寫 `services/googlePhotos.js`，使用 `axios` 直接呼叫 REST API。
  - 端點: `https://photoslibrary.googleapis.com/v1/albums`。

### 階段 2: 403 Forbidden 錯誤排查
- **症狀**: 
  - OAuth 登入成功。
  - 取得 Token 成功。
  - 但呼叫 `/api/albums` 時，Google API 返回 `403 Forbidden`。
  
- **診斷步驟**:
  1.  **檢查 Scope (權限範圍)**: 
      - 使用 `/debug/token-info` 診斷端點。
      - 結果: Token 確實包含 `readonly` 和 `appendonly` 權限。 (✅ 排標)
  2.  **檢查測試使用者**:
      - 確認 Google Cloud Console 的 OAuth 同意畫面為「測試」狀態。
      - 確認開發者 Email 已加入測試使用者清單。 (✅ 排除)
  3.  **檢查 API 啟用狀態**:
      - 確認 Photos Library API 已在 Console 中啟用。 (✅ 排除)
  4.  **檢查配額 (Quota)**:
      - 檢查 API 配額使用量，僅使用了 5 次 (遠低於 10,000 次限制)。 (✅ 排除)
  5.  **嘗試發布應用程式**:
      - 使用者嘗試點擊發布，但因需審核而取消，維持測試模式。

- **最終診斷結果 (Root Cause)**:
  - 問題出在 **Google Cloud 專案未啟用計費帳戶 (Billing Account)**。
  - Google Photos Library API 屬於敏感 API，Google 強制要求專案必須連結計費帳戶才能使用，即使是在免費配額內。

---

## 📝 最終結論與解決方案

### 系統現況
1.  **程式碼完備**: 後端邏輯、OAuth 流程、API 呼叫代碼皆已修正並驗證無誤。
2.  **功能正常**: 伺服器運行正常，前端介面可操作。
3.  **唯一阻礙**: Google API 的 403 限制。

### 下一步行動 (Action Items)
為了讓系統能正常抓取相簿，必須執行以下行政設定 (非程式碼修改)：

1.  **啟用計費**:
    - 前往 Google Cloud Console > 計費。
    - 連結信用卡 (免費額度內不收費)。
2.  **重置授權**:
    - 啟用計費後，前往 Google 帳戶權限頁面移除應用程式授權。
    - 等待 5-10 分鐘讓設定生效。
3.  **重新登入**:
    - 回到 App 重新進行 OAuth 登入。

---

## 📂 相關檔案變更
- `services/googlePhotos.js`: 改用 axios 實作 REST API 呼叫。
- `routes/debug.js`: 新增診斷端點 (開發環境用)。
- `package.json`: 新增 `axios` 依賴。
- `403錯誤診斷報告.md`: 詳細的錯誤分析報告。
- `walkthrough.md`: 專案完整開發報告。

---
*記錄時間: 2025-12-30*

---

### 階段 3: 黃金證據 (Golden Evidence) - 終極排查
**時間**: 2025-12-30 (Day 2)

為了100%確定 403 錯誤非程式碼問題，我們進行了深度除錯：

1.  **程式碼增強 (Instrumentation)**:
    -   在 `routes/auth.js` 中手動加入 `getTokenInfo` 檢查。
    -   在登入後直接印出 Google 發給 Token 的實際 Scope。
    -   在 `services/googlePhotos.js` 調整 Scope 為 `readonly` + `appendonly`。

2.  **關鍵日誌輸出**:
    ```text
    ================ [Google 權限檢查報告] ================
    Token 有效性: ✅ 有效
    實際擁有的權限 (Scopes):
     - https://www.googleapis.com/auth/photoslibrary.readonly
     - https://www.googleapis.com/auth/photoslibrary
     - https://www.googleapis.com/auth/photoslibrary.sharing
    -----------------------------------------------------
    ✅ 檢測結果: 成功！Token 包含讀取相簿權限。
    =====================================================
    
    [錯誤發生]: Request had insufficient authentication scopes.
    code: 403
    ```

3.  **判讀結果**: 
    -   日誌顯示 **Token 確實已經擁有所有必要的 Scope**。
    -   但 API 仍然回應 **權限不足 (Insufficient Scopes)**。
    -   **結論**: 這是一個自相矛盾的錯誤，它是 Google用來阻擋「未啟用計費帳戶」專案的標準行為。這份日誌成為了鐵證，證明問題不在程式碼、不在 Scope 設定，而 **絕對** 在於 Google Cloud Project 的計費狀態。

4.  **最終建議**:
    -   保留 `googlePhotos.js` 中使用 `axios` 的正確寫法。
    -   唯一的解決方案是前往 Google Cloud Console 啟用計費。

---
*更新時間: 2025-12-30 13:20*
