# 🔧 Google Photos API 問題診斷與解決方案

**日期**: 2025-12-29  
**問題**: 無法取得相簿清單

---

## 🔍 問題現象

- ✅ OAuth 登入成功
- ✅ 成功跳轉到 dashboard 頁面
- ❌ 顯示錯誤: "載入失敗: 無法取得相簿清單"

---

## 🎯 根本原因分析

根據錯誤日誌和症狀,最可能的原因是:

### 1. Photos Library API 未啟用 (最可能)

雖然您已經建立了 OAuth 憑證,但 **Photos Library API 本身可能沒有啟用**。

### 2. OAuth 範圍未生效

即使在 Google Cloud Console 設定了範圍,舊的授權 token 可能沒有包含新範圍。

---

## ✅ 解決方案

### 方案 1: 確認並啟用 Photos Library API (必做)

#### 步驟:

1. **前往 Google Cloud Console**
   - https://console.cloud.google.com/

2. **選擇專案**
   - 確認選擇了 "Smart Photo Album"

3. **進入 API 程式庫**
   - 左側選單 → "API 和服務" → "程式庫"

4. **搜尋 Photos Library API**
   - 在搜尋框輸入: `Photos Library API`
   - 點擊搜尋結果

5. **啟用 API**
   - 如果顯示「啟用」按鈕,點擊它
   - 如果已啟用,會顯示「管理」或「API 已啟用」

6. **等待啟用完成**
   - 通常需要 10-30 秒

---

### 方案 2: 完全重置授權

#### 步驟:

1. **清除 Google 帳號授權**
   - 前往: https://myaccount.google.com/permissions
   - 找到 "Smart Photo Album"
   - 點擊「移除存取權」

2. **清除瀏覽器 Cookie**
   - 在 http://localhost:3001 按 F12
   - 前往 Application → Cookies
   - 刪除所有 localhost:3001 的 cookies

3. **重新登入**
   - 前往 http://localhost:3001
   - 點擊「連接 Google Photos」
   - **仔細查看授權頁面**,確認有要求存取 Google Photos
   - 點擊「允許」

---

### 方案 3: 檢查 OAuth 同意畫面設定

#### 確認範圍已正確設定:

1. **前往 OAuth 同意畫面**
   - Google Cloud Console → OAuth 同意畫面

2. **檢查範圍**
   - 確認包含這兩個:
     - `https://www.googleapis.com/auth/photoslibrary.readonly`
     - `https://www.googleapis.com/auth/photoslibrary.appendonly`

3. **檢查測試使用者**
   - 確認您的 Gmail 地址在測試使用者清單中

---

## 🧪 測試步驟

完成上述方案後:

### 1. 重啟伺服器

```bash
# 停止伺服器 (Ctrl+C)
# 重新啟動
npm start
```

### 2. 測試流程

1. 前往 http://localhost:3001
2. 點擊「連接 Google Photos」
3. 完成授權
4. 應該能看到相簿清單

---

## 📋 檢查清單

請依序檢查:

- [ ] Photos Library API 已在 Google Cloud Console 啟用
- [ ] OAuth 同意畫面包含正確的範圍
- [ ] 測試使用者清單包含您的帳號
- [ ] 已移除舊的 Google 帳號授權
- [ ] 已清除瀏覽器 cookies
- [ ] 重新登入並授權
- [ ] 能看到相簿清單

---

## 🔍 進階診斷

如果以上方案都無效,請檢查:

### 1. 查看詳細錯誤

在終端機中查看伺服器日誌,找到類似這樣的錯誤:

```
[2025-12-29T09:40:43.145Z] ❌ ERROR: 取得相簿清單失敗: {
  message: "...",
  code: "...",
  status: "...",
  data: "..."
}
```

### 2. 常見錯誤碼

- **403 Forbidden**: API 未啟用或範圍不足
- **401 Unauthorized**: Token 無效或過期
- **404 Not Found**: API 端點錯誤
- **429 Too Many Requests**: 超過配額限制

---

## 💡 最可能的解決方案

**99% 的情況下,問題是 Photos Library API 沒有啟用!**

### 快速修復:

1. 前往: https://console.cloud.google.com/apis/library/photoslibrary.googleapis.com?project=smart-photo-album-482706
2. 點擊「啟用」
3. 等待 30 秒
4. 重新登入應用程式

---

## 📞 需要協助?

如果問題仍然存在:

1. 截圖伺服器終端機的錯誤訊息
2. 截圖 Google Cloud Console 的 API 啟用狀態
3. 告訴我具體的錯誤訊息

---

**現在請先確認 Photos Library API 是否已啟用!** 🔑
